pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
debug=1

cam={
	initx=64,inity=64,
	pov=16,
	x=0,y=0,
	}

function _init()
 camera()
	circuit:init()
 car:init()
end

function _update()
	if (btn(0)) car.angle-=.01
	if (btn(1)) car.angle+=.01
	if (btn(2)) car.speed+=.1
	if (btn(3)) car.speed-=.1
	if (btn(4))then
	 car.x,car.y=64,80
	end
	
	if((car.angle>1)or(car.angle<0)) car.angle=car.angle%1
	if(car.speed>4.4) car.speed=4.4
	if(car.speed<-.4) car.speed=-.4
	
	car:update()
	
	cam.x=car.x-cam.initx+cos(car.angle)*cam.pov
	cam.y=car.y-cam.inity-sin(car.angle)*cam.pov
	if(car.x<cam.initx-cos(car.angle)*cam.pov) cam.x=0
	if(car.x>24*circuit.sizex-cam.initx+cos(car.angle)*cam.pov)then
		cam.x=24*circuit.sizex-128
 end
	if(car.y<cam.inity+sin(car.angle)*cam.pov) cam.y=0
	--if(car.y>24*circuit.sizey-64) cam.y=24*circuit.sizey-128
	
	camera(cam.x,cam.y)
end

function _draw()
	cls()
	
	--sprite_zoom(0,0,8,0,32,16,16)
	--spr(1,40,40)
	--spr(2,70,50)
	circuit:draw()
	car:draw()

	if(debug==1)then
		line(0,80,384,80,7)
		line(0,48,384,48,7)
		print(car.angle..", "..car.speed,cam.x+5,cam.y+1,7)
		print(car.x..", "..car.y,cam.x+5,cam.y+11,7)
		print(cam.x..", "..cam.y,cam.x+5,cam.y+17,7)
	 print("mem "..flr(stat(0)),cam.x+60,cam.y+1,7)
	 print("cpu "..flr(stat(1)),cam.x+90,cam.y+1,7)
	end
end

function sprite_zoom(x,y,scale,pixoffsetx,pixoffsety,sizex,sizey)
	local xp,yp,col=0
	for xos=0,sizex*scale do
		for yos=0,sizey*scale do
			xp=xos/scale
			yp=yos/scale--(yos-40)/scale
			col=sget(pixoffsetx+xp,pixoffsety+yp)
			if(col!=0)pset(x+xos,y+yos,col)
		end
	end
end

function draw_rotation(x,y,angle,pixoffsetx,pixoffsety)
	ca,sa=cos(angle),sin(angle)
	scale=1

	local xp=0
	local yp=0
	for xo=-4,7 do
		for yo=-4,7 do
			xp=((xo*ca+yo*sa)+(4*scale))/scale
			yp=((-xo*sa+yo*ca)+(4*scale))/scale
			if((xp>=0)and(xp<8)
					and(yp>=0)and(yp<8))then
				col=sget(pixoffsetx+xp,pixoffsety+yp)
				if(col!=0)	pset(x+xo,y+yo,col)
			end
		end
	end
end
-->8
car={
	model=0,
	x=64,y=64,
	angle=.75,speed=1,
	sosx=0,sosy=0 -- sprite offset
	}
	
function car:init()
 if(self.model==0)then
 	-- hero
 	self.sosy=8
 end
end

function car:update()
	x,y=self.x,self.y
	s=self.speed
	ca,sa=cos(self.angle),sin(self.angle)

	self.x+=ca*s
	self.y-=sa*s
end

function car:draw()
	x,y=self.x,self.y
	s=self.speed
	--ca,sa=cos(self.angle),sin(self.angle)

	--if(t()%2==0)then spr(16,x-4,y-4)
	--else spr(17,x-4,y-4)
	--end
	draw_rotation(x,y,-self.angle,self.sosx,self.sosy)

	if(debug==1)then
	 rect(x-4,y-4,x+4,y+4,7)
		line(x,y,x+cos(self.angle)*s*2,y-sin(self.angle)*s*2,7)
	end	
end

-->8
circuit={
	model=0,
	x=0,y=0,
	sizex=0,sizey=0,
	}
	
tiles={
	{c=0,x=6,y=0,w=3,h=3},
	{c=1,x=0,y=0,w=3,h=3},
	{c=2,x=3,y=0,w=3,h=3},
	{c=3,x=0,y=3,w=3,h=3},
	{c=4,x=3,y=3,w=3,h=3},
	{c=5,x=0,y=6,w=3,h=3},
	{c=6,x=3,y=6,w=3,h=3},
	{c=7,x=9,y=0,w=3,h=3},
	}

function circuit:init()
 if(self.model==0)then
  self.x,self.y=0,32
  self.sizex,self.sizey=16,8
 end
end

function circuit:draw()
 sizex=self.x+self.sizex
 sizey=self.y+self.sizey
 print(sizex..", "..sizey,60,60,7)
 
 for i=self.x,sizex do
 	for j=self.y,sizey do
			col=sget(i,j)
			draw_tile(i-self.x,j-self.y,col)
 	end
 end
end

function draw_tile(x,y,c)
	found=false
	i=1

	repeat
	 if(tiles[i].c==c)then
	  celx,cely=tiles[i].x,tiles[i].y
		 celw,celh=tiles[i].w,tiles[i].h
		 found=true
	 else
	  i+=1
	 end
	until found==true

	map(celx,cely,x*24,y*24,celw,celh)
end
__gfx__
00000000333b3333111c111166666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b3333b3bc1111c1c66666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007003b3333331c11111166666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770003333b33b1111c11c66666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700033b3333311c1111166666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007003b333b331c111c1166666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000003333333b1111111c66666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333b3333111c111166666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05500000056000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06500650056005600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
880ee008880ee0080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88eeeee888eeeee80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88eeeee888eeeee80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
880ee008880ee0080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06500650056005600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05500000056000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32222222222222240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
52222222222222260000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555333333333355555555333333333355555555555555555555330000000000000000000000000000000000000000000000000000000000000000
33555555555555333333333355555555333333334070707070707070707074330000000000000000000000000000000000000000000000000000000000000000
33555555555555335555555555555555553333334707070707070707070704330000000000000000000000000000000000000000000000000000000000000000
33555555555555335555555555555555555533333470707070707070707070430000000000000000000000000000000000000000000000000000000000000000
33555555555555335555555555555555555553333455555555555555555555430000000000000000000000000000000000000000000000000000000000000000
33555555555555335555555555555555555553333466666666666666666666430000000000000000000000000000000000000000000000000000000000000000
33555555555555335555555533333333555555333355555555555555555555330000000000000000000000000000000000000000000000000000000000000000
33555555555555335555555533333333555555333355555555555555555555330000000000000000000000000000000000000000000000000000000000000000
3333333333333333333b333355555555335555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333333333333b3333b3b55555555335555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333355555555553b33333355555555333555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33335555555555553333b33b55555555333555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
333555555555555533b3333355555555333355550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33355555555555553b333b3355555555333333550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555553333333b55555555333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3355555555555555333b333355555555333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555555555555555555533555555333355555500000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555555555555555555533555555333355555500000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555555555555555555333555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555555555555555555333555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555555555555555553333555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555555555555555333333555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555333355555533333333555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
33555555555555333355555533333333555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
8093818282829292928093810000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8093819393939292928586870000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8093818383839292928093810000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9091918282840000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a093939393810000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a093a1a293810000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8093a4a593810000008800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
8093939393810000008800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9483838383a30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
